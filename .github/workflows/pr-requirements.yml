name: PR Requirements Check

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]

jobs:
  check-requirements:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Check PR has linked issue with assignee
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prBody = pr.body || '';
            const prTitle = pr.title || '';

            // Extract issue numbers from body and title
            // Matches: fixes #123, closes #123, resolves #123, or plain #123
            const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)?\s*#(\d+)/gi;

            const allText = `${prTitle} ${prBody}`;
            const matches = [...allText.matchAll(issuePattern)];
            const issueNumbers = [...new Set(matches.map(m => parseInt(m[1], 10)))];

            console.log(`PR #${prNumber}:`);
            console.log(`  Found issue references: ${issueNumbers.length > 0 ? issueNumbers.join(', ') : 'none'}`);

            if (issueNumbers.length === 0) {
              const message = `## PR Closed - Requirements Not Met

            This PR has been automatically closed because it doesn't meet the requirements.

            **Missing:** No linked issue found.

            **To fix:**
            1. Create or find an existing issue for this work
            2. Ensure the issue has an assignee
            3. Re-open this PR and add \`Fixes #123\` in the description`;

              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const botComment = comments.data.find(
                (c) => c.user.type === 'Bot' && c.body.includes('PR Requirements Not Met')
              );

              if (!botComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: message,
                });
              }

              // Close the PR
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed',
              });

              core.setFailed('PR must reference an issue');
              return;
            }

            // Check if any linked issue has an assignee
            let issueWithAssignee = null;
            let issuesWithoutAssignee = [];

            for (const issueNum of issueNumbers) {
              try {
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNum,
                });

                if (issue.assignees && issue.assignees.length > 0) {
                  issueWithAssignee = issueNum;
                  console.log(`  Issue #${issueNum} has assignee(s): ${issue.assignees.map(a => a.login).join(', ')}`);
                  break;
                } else {
                  issuesWithoutAssignee.push(issueNum);
                  console.log(`  Issue #${issueNum} has no assignee`);
                }
              } catch (error) {
                console.log(`  Issue #${issueNum} not found or inaccessible`);
              }
            }

            if (!issueWithAssignee) {
              const message = `## PR Closed - Requirements Not Met

            This PR has been automatically closed because it doesn't meet the requirements.

            **Found issues:** ${issuesWithoutAssignee.map(n => `#${n}`).join(', ')}
            **Problem:** None of the linked issues have an assignee.

            **To fix:**
            1. Assign someone to one of the linked issues
            2. Re-open this PR`;

              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const botComment = comments.data.find(
                (c) => c.user.type === 'Bot' && c.body.includes('PR Requirements Not Met')
              );

              if (!botComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: message,
                });
              }

              // Close the PR
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed',
              });

              core.setFailed('Linked issue must have an assignee');
            } else {
              console.log(`PR requirements met! Issue #${issueWithAssignee} has an assignee.`);
            }
